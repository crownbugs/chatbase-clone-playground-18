(function() {
  'use strict';
  
  // Get config from window or script attributes
  const config = window.chatbaseConfig || {};
  const currentScript = document.currentScript;
  const chatbotId = config.chatbotId || currentScript?.getAttribute('chatbotId');
  const domain = config.domain || currentScript?.getAttribute('domain') || window.location.origin;
  
  if (!chatbotId) {
    console.error('Chatbase: chatbotId is required');
    return;
  }
  
  // Create chat widget
  function createChatWidget() {
    // Create container
    const container = document.createElement('div');
    container.id = 'chatbase-widget';
    container.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;
    
    // Create toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'chatbase-toggle';
    toggleBtn.innerHTML = `
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
      </svg>
    `;
    toggleBtn.style.cssText = `
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: hsl(222.2 84% 4.9%);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    `;
    
    // Create chat iframe
    const chatFrame = document.createElement('iframe');
    chatFrame.id = 'chatbase-frame';
    chatFrame.src = `https://rebur.co/chat/${chatbotId}`;
    chatFrame.style.cssText = `
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 380px;
      height: 600px;
      border: none;
      border-radius: 12px;
      background: white;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      display: none;
      max-width: calc(100vw - 40px);
      max-height: calc(100vh - 120px);
    `;
    
    // Mobile responsiveness
    if (window.innerWidth <= 768) {
      chatFrame.style.cssText += `
        width: calc(100vw - 40px);
        height: calc(100vh - 120px);
        bottom: 70px;
        right: 0;
      `;
    }
    
    let isOpen = false;
    
    // Toggle functionality
    toggleBtn.addEventListener('click', function() {
      isOpen = !isOpen;
      chatFrame.style.display = isOpen ? 'block' : 'none';
      toggleBtn.innerHTML = isOpen ? 
        `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
           <line x1="18" y1="6" x2="6" y2="18"></line>
           <line x1="6" y1="6" x2="18" y2="18"></line>
         </svg>` :
        `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
           <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
         </svg>`;
    });
    
    // Hover effects
    toggleBtn.addEventListener('mouseenter', function() {
      this.style.transform = 'scale(1.05)';
      this.style.background = 'hsl(222.2 84% 7%)';
    });
    
    toggleBtn.addEventListener('mouseleave', function() {
      this.style.transform = 'scale(1)';
      this.style.background = 'hsl(222.2 84% 4.9%)';
    });
    
    // Close chat when clicking outside
    document.addEventListener('click', function(e) {
      if (isOpen && !container.contains(e.target)) {
        isOpen = false;
        chatFrame.style.display = 'none';
        toggleBtn.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        `;
      }
    });
    
    // Handle window resize
    window.addEventListener('resize', function() {
      if (window.innerWidth <= 768) {
        chatFrame.style.width = 'calc(100vw - 40px)';
        chatFrame.style.height = 'calc(100vh - 120px)';
      } else {
        chatFrame.style.width = '380px';
        chatFrame.style.height = '600px';
      }
    });
    
    // Assemble widget
    container.appendChild(toggleBtn);
    container.appendChild(chatFrame);
    document.body.appendChild(container);
    
    // Auto-open if configured
    if (config.autoOpen) {
      setTimeout(() => {
        toggleBtn.click();
      }, 1000);
    }
  }
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', createChatWidget);
  } else {
    createChatWidget();
  }
  
  // Expose API for custom interactions
  window.Chatbase = {
    open: function() {
      const toggle = document.getElementById('chatbase-toggle');
      const frame = document.getElementById('chatbase-frame');
      if (toggle && frame && frame.style.display === 'none') {
        toggle.click();
      }
    },
    close: function() {
      const toggle = document.getElementById('chatbase-toggle');
      const frame = document.getElementById('chatbase-frame');
      if (toggle && frame && frame.style.display === 'block') {
        toggle.click();
      }
    },
    toggle: function() {
      const toggle = document.getElementById('chatbase-toggle');
      if (toggle) toggle.click();
    }
  };
})();